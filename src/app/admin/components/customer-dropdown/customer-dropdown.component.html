<!-- src/app/admin/components/customer-dropdown/customer-dropdown.component.html -->

<div class="relative" (clickOutside)="onClickOutside()">
  <!-- Selected Value / Trigger Button -->
  <button
    type="button"
    (click)="toggleDropdown()"
    [disabled]="disabled || isLoading()"
    class="w-full px-3 py-2 text-left border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-neutral-800 focus:border-transparent transition-all bg-white flex items-center justify-between"
    [class.opacity-50]="disabled"
    [class.cursor-not-allowed]="disabled || isLoading()"
  >
    <span class="flex-1 truncate">
      @if (isLoading()) {
      <span class="text-neutral-500">Loading data...</span>
      } @else if (loadError()) {
      <span class="text-red-600 text-sm">{{ loadError() }}</span>
      } @else if (selectedCustomer()) {
      <span class="text-neutral-900">{{ selectedCustomer()!.nama }}</span>
      } @else {
      <span class="text-neutral-500">Choose Customer/Supplier</span>
      }
    </span>

    <div class="flex items-center gap-1 ml-2">
      @if (selectedCustomer() && !disabled && !isLoading()) {
      <button
        type="button"
        (click)="clearSelection(); $event.stopPropagation()"
        class="p-1 hover:bg-neutral-100 rounded transition-colors"
      >
        <svg class="w-4 h-4 text-neutral-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
      }

      <svg
        class="w-5 h-5 text-neutral-400 transition-transform"
        [class.rotate-180]="isOpen()"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </div>
  </button>

  <!-- Dropdown Panel -->
  @if (isOpen() && !isLoading() && !loadError()) {
  <div
    class="absolute z-50 w-full mt-1 bg-white border border-neutral-300 rounded-lg shadow-lg max-h-64 overflow-hidden"
  >
    <!-- Search Input -->
    <div class="p-2 border-b border-neutral-200">
      <div class="relative">
        <input
          type="text"
          [value]="searchQuery()"
          (input)="onSearchChange($any($event.target).value)"
          placeholder="Find Customer/Supplier..."
          class="w-full pl-8 pr-3 py-2 text-sm border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-neutral-800 focus:border-transparent"
          (click)="$event.stopPropagation()"
        />
        <svg
          class="absolute left-2.5 top-2.5 w-4 h-4 text-neutral-400"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
      </div>
    </div>

    <!-- Customer List -->
    <div class="max-h-48 overflow-y-auto">
      @if (filteredCustomers().length === 0) {
      <div class="px-4 py-8 text-center text-sm text-neutral-500">
        @if (searchQuery()) {
        <p>Tidak ada hasil untuk "{{ searchQuery() }}"</p>
        } @else {
        <p>Belum ada customer/supplier</p>
        }
      </div>
      } @else {
      <div class="py-1">
        @for (customer of filteredCustomers(); track customer.id + '-' + customer.type) {
        <button
          type="button"
          (click)="selectCustomer(customer)"
          class="w-full px-4 py-2 text-left text-sm hover:bg-neutral-50 transition-colors flex items-center justify-between gap-2"
          [class.bg-neutral-100]="
            selectedCustomer()?.id === customer.id && selectedCustomer()?.type === customer.type
          "
        >
          <div class="flex items-center gap-2 flex-1 min-w-0">
            <span class="text-neutral-900 truncate">{{ customer.nama }}</span>
            <span
              class="text-xs px-2 py-0.5 rounded-full flex-shrink-0"
              [class.bg-blue-100]="customer.type === 'customer'"
              [class.text-blue-700]="customer.type === 'customer'"
              [class.bg-green-100]="customer.type === 'supplier'"
              [class.text-green-700]="customer.type === 'supplier'"
            >
              {{ customer.type === 'customer' ? 'Customer' : 'Supplier' }}
            </span>
          </div>
          @if (selectedCustomer()?.id === customer.id && selectedCustomer()?.type === customer.type)
          {
          <svg
            class="w-4 h-4 text-neutral-800 flex-shrink-0"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
              clip-rule="evenodd"
            />
          </svg>
          }
        </button>
        }
      </div>
      }
    </div>

    <!-- Footer with count -->
    <div class="px-4 py-2 bg-neutral-50 border-t border-neutral-200">
      <p class="text-xs text-neutral-600">
        Total: <span class="font-semibold">{{ customers().length }}</span> customer/supplier
      </p>
    </div>
  </div>
  }

  <!-- Retry Button if load failed -->
  @if (loadError() && !isLoading()) {
  <button
    type="button"
    (click)="loadCustomers()"
    class="mt-2 w-full px-3 py-2 text-sm bg-blue-50 text-blue-700 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors"
  >
    Coba Muat Ulang
  </button>
  }
</div>

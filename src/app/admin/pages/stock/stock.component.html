<!-- src/app/admin/pages/stock/stock.component.html -->

<div class="stock-container">
  <!-- Header -->
  <div class="header no-print">
    <div class="flex items-center justify-start gap-3">
      <img src="ads-logo1.png" class="w-10 h-auto" alt="PT. Agro Deli Serdang" />
      <h1 class="title">Stock Management</h1>
    </div>
    <p class="subtitle">Real-time raw material inventory tracking</p>
  </div>

  <!-- Compact Filter & Actions -->
  <div class="filter-section no-print">
    <div class="filter-compact">
      <div class="filter-compact-header">
        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
          />
        </svg>
        <span class="filter-compact-title">Filter</span>
      </div>

      <select
        [value]="selectedBarang()"
        (change)="onBarangChange($any($event.target).value)"
        class="filter-compact-select"
      >
        <option *ngFor="let option of bahanBakuOptions" [value]="option.value">
          {{ option.label }}
        </option>
      </select>

      <div class="filter-actions">
        <button (click)="openPemakaianModal()" class="action-btn action-btn-danger">
          <lucide-icons
            [iconsName]="'package-minus'"
            [color]="'white'"
            [strokewidth]="2"
            class="gray"
          />
          <span>Add Usage</span>
        </button>

        <button (click)="openHistoryModal()" class="action-btn action-btn-primary">
          <lucide-icons [iconsName]="'history'" [color]="'white'" [strokewidth]="2" class="gray" />
          <span>History</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading()" class="loading-container">
    <div class="flex flex-col items-center justify-center py-12">
      <div class="w-12 h-12 mb-4 border-b-2 border-blue-600 rounded-full animate-spin"></div>
      <p class="text-gray-600">Loading stock data...</p>
    </div>
  </div>

  <!-- Stock Data Table -->
  <div class="data-section" *ngIf="!isLoading()">
    <h3 class="section-title">Stock Inventory ({{ filteredStockData().length }} items)</h3>

    <!-- Empty State -->
    <div *ngIf="filteredStockData().length === 0" class="empty-state">
      <div class="flex flex-col items-center justify-center py-12">
        <svg
          class="w-16 h-16 mb-4 text-gray-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
          />
        </svg>
        <h3 class="mb-2 text-lg font-semibold text-gray-900">No stock data available</h3>
        <p class="text-gray-600">No data for the selected item</p>
      </div>
    </div>

    <!-- Table -->
    <div *ngIf="filteredStockData().length > 0" class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>No.</th>
            <th>Item Name</th>
            <th>Opening Stock</th>
            <th>Received</th>
            <th>Used</th>
            <th>Closing Stock</th>
            <th>Unit</th>
            <!-- <th>Stock Level</th> -->
            <th>Last Updated</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of filteredStockData(); let i = index">
            <td class="text-center">{{ i + 1 }}</td>
            <td>
              <strong>{{ item.barang }}</strong>
            </td>
            <td class="text-right">{{ formatNumber(item.stock_awal) }}</td>
            <td class="text-right text-green-600">+{{ formatNumber(item.penerimaan) }}</td>
            <td class="text-right text-red-600">-{{ formatNumber(item.pemakaian) }}</td>
            <td class="text-right">
              <strong>{{ formatNumber(item.stock_akhir) }}</strong>
            </td>
            <td class="text-center">{{ item.satuan }}</td>
            <!-- <td class="text-center">
              <div class="stock-level-bar">
                <div
                  class="stock-level-fill"
                  [class.level-high]="item.stock_akhir / item.stock_awal > 0.5"
                  [class.level-medium]="
                    item.stock_akhir / item.stock_awal <= 0.5 &&
                    item.stock_akhir / item.stock_awal > 0.2
                  "
                  [class.level-low]="item.stock_akhir / item.stock_awal <= 0.2"
                  [style.width.%]="(item.stock_akhir / item.stock_awal) * 100"
                >
                  <span class="level-text"
                    >{{ ((item.stock_akhir / item.stock_awal) * 100).toFixed(1) }}%</span
                  >
                </div>
              </div>
            </td> -->
            <td class="text-center">{{ formatDate(item.last_updated) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Period Report Section -->
  <div class="detail-stats" *ngIf="isRincianVisible() && !isLoading()">
    <div class="flex items-center justify-between mb-4">
      <h3 class="mb-0 section-title">Raw Material Period Report</h3>
    </div>

    <!-- Period Filter -->
    <div class="period-filter">
      <div class="filter-row">
        <div class="filter-item">
          <label class="filter-label">Report Period:</label>
          <input
            type="date"
            [value]="periodStartDate()"
            (change)="periodStartDate.set($any($event.target).value); calculatePeriodReport()"
            class="filter-input-date"
          />
          <span class="date-separator">to</span>
          <input
            type="date"
            [value]="periodEndDate()"
            (change)="periodEndDate.set($any($event.target).value); calculatePeriodReport()"
            class="filter-input-date"
          />
        </div>
      </div>
      <div class="period-display">
        Period:
        <strong
          >{{ formatDateShort(periodStartDate()) }} - {{ formatDateShort(periodEndDate()) }}</strong
        >
      </div>
    </div>

    <div class="w-full my-3 border-b border-gray-100"></div>

    <!-- Period Report Table -->
    <div class="table-container">
      <table class="period-report-table">
        <thead>
          <tr>
            <th class="text-left">Item</th>
            <!-- <th class="text-left">Description</th> -->
            <th class="text-right">Beginning Balance (Kg)</th>
            <th class="text-right">Received in Period (Kg)</th>
            <th class="text-right">Used in Period (Kg)</th>
            <th class="text-right">Ending Balance (Kg)</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let report of periodReportData()" [class.total-row]="report.isTotal">
            <!-- <td class="text-left">{{ report.item }}</td> -->
            <td class="text-left">{{ report.description }}</td>
            <td class="text-right">{{ formatNumber(report.beginningBalance) }}</td>
            <td class="text-right text-green-600">{{ formatNumber(report.receivedInPeriod) }}</td>
            <td class="text-right text-red-600">{{ formatNumber(report.usedInPeriod) }}</td>
            <td class="font-semibold text-right">{{ formatNumber(report.endingBalance) }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="report-footer">
      <span class="report-date">{{ getCurrentDateFormatted() }}</span>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons no-print" *ngIf="!isLoading()">
    <button
      class="flex items-center justify-center w-auto gap-3 text-white btn bg-neutral-800"
      (click)="toggleRincian()"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          [attr.d]="isRincianVisible() ? 'M5 15l7-7 7 7' : 'M19 9l-7 7-7-7'"
        />
      </svg>
      <span>{{ isRincianVisible() ? 'Hide' : 'Show' }} Period Report</span>
    </button>

    <button
      *ngIf="isRincianVisible()"
      class="flex items-center justify-center w-auto gap-3 text-white btn bg-neutral-800"
      (click)="exportPeriodToExcel()"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
        />
      </svg>
      Export to Excel
    </button>

    <button
      *ngIf="isRincianVisible()"
      class="flex items-center justify-center w-auto gap-3 bg-gray-200 btn text-neutral-800"
      (click)="printPeriodReport()"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"
        />
      </svg>
      Print Report
    </button>
  </div>
</div>

<!-- PRINT REPORT (A4 OPTIMIZED) -->
<div class="print-report-a4">
  <div class="print-header-a4">
    <div class="print-header-top">
      <img src="ads-logo1.png" alt="Logo PT Agro Deli Serdang" class="print-logo-a4" />
      <div class="print-title-block">
        <h1 class="print-title">PT AGRO DELI SERDANG</h1>
        <p class="print-subtitle">RAW MATERIAL PERIOD REPORT</p>
      </div>
    </div>
    <div class="print-meta-row">
      <div>
        Period:
        <strong
          >{{ formatDateShort(periodStartDate()) }} - {{ formatDateShort(periodEndDate()) }}</strong
        >
      </div>
      <div>
        Print Date: <strong>{{ getCurrentDateFormatted() }}</strong>
      </div>
      <div *ngIf="selectedBarang() !== 'semua'">
        Filter: <strong>{{ selectedBarang() }}</strong>
      </div>
    </div>
  </div>

  <!-- Period Report Table -->
  <table class="print-period-table">
    <thead>
      <tr>
        <th>Item</th>
        <!-- <th>Description</th> -->
        <th>Beginning Balance (Kg)</th>
        <th>Received in Period (Kg)</th>
        <th>Used in Period (Kg)</th>
        <th>Ending Balance (Kg)</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let report of periodReportData()" [class.print-total-row]="report.isTotal">
        <!-- <td>{{ report.item }}</td> -->
        <td>{{ report.description }}</td>
        <td class="text-right">{{ formatNumber(report.beginningBalance) }}</td>
        <td class="text-right">{{ formatNumber(report.receivedInPeriod) }}</td>
        <td class="text-right">{{ formatNumber(report.usedInPeriod) }}</td>
        <td class="text-right">
          <strong>{{ formatNumber(report.endingBalance) }}</strong>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Print Footer -->
  <div class="print-footer-a4">
    <p>{{ getCurrentDateFormatted() }}</p>
  </div>
</div>

<!-- Modal Penerimaan -->
<div *ngIf="showPenerimaanModal()" class="modal-overlay" (click)="closePenerimaanModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Material Receipt</h2>
      <button class="modal-close" (click)="closePenerimaanModal()">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>

    <form [formGroup]="penerimaanForm" (ngSubmit)="submitPenerimaan()" class="modal-body">
      <div class="info-grid">
        <div class="form-group">
          <label class="form-label">Item Type <span class="text-red-500">*</span></label>
          <select formControlName="barang" class="form-input">
            <option value="">Select Item</option>
            <option *ngFor="let option of bahanBakuOptions.slice(1)" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Quantity (Kg) <span class="text-red-500">*</span></label>
          <input type="number" formControlName="jumlah" class="form-input" placeholder="0" />
        </div>

        <div class="form-group">
          <label class="form-label">Receipt No. <span class="text-red-500">*</span></label>
          <input type="text" formControlName="nomor_bon" class="form-input" placeholder="DLK-001" />
        </div>

        <div class="form-group">
          <label class="form-label">Vehicle No. <span class="text-red-500">*</span></label>
          <input
            type="text"
            formControlName="nomor_kendaraan"
            class="form-input"
            placeholder="BK 123 ADS"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Supplier <span class="text-red-500">*</span></label>
          <input
            type="text"
            formControlName="suplier"
            class="form-input"
            placeholder="Supplier Name"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Driver <span class="text-red-500">*</span></label>
          <input type="text" formControlName="supir" class="form-input" placeholder="Driver Name" />
        </div>

        <div class="form-group">
          <label class="form-label">Date <span class="text-red-500">*</span></label>
          <input type="date" formControlName="tanggal" class="form-input" />
        </div>

        <div class="form-group">
          <label class="form-label">Officer <span class="text-red-500">*</span></label>
          <input
            type="text"
            formControlName="petugas"
            class="form-input"
            placeholder="Officer Name"
          />
        </div>
      </div>

      <div class="mt-4 form-group">
        <label class="form-label">Notes</label>
        <textarea
          formControlName="keterangan"
          rows="3"
          class="form-input"
          placeholder="Additional notes (optional)"
        ></textarea>
      </div>
    </form>

    <div class="modal-footer">
      <button type="button" (click)="closePenerimaanModal()" class="btn-secondary">Cancel</button>
      <button
        type="submit"
        [disabled]="!penerimaanForm.valid"
        (click)="submitPenerimaan()"
        class="text-white bg-green-600 btn"
      >
        Save Receipt
      </button>
    </div>
  </div>
</div>

<!-- Modal Pemakaian -->
<div *ngIf="showPemakaianModal()" class="modal-overlay" (click)="closePemakaianModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Material Usage</h2>
      <button class="modal-close" (click)="closePemakaianModal()">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>

    <form [formGroup]="pemakaianForm" (ngSubmit)="submitPemakaian()" class="modal-body">
      <div class="info-grid">
        <div class="form-group">
          <label class="form-label">Item Type <span class="text-red-500">*</span></label>
          <select formControlName="barang" class="form-input">
            <option value="">Select Item</option>
            <option *ngFor="let option of bahanBakuOptions.slice(1)" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Quantity (Kg) <span class="text-red-500">*</span></label>
          <input type="number" formControlName="jumlah" class="form-input" placeholder="0" />
        </div>

        <div class="form-group">
          <label class="form-label">Usage No. <span class="text-red-500">*</span></label>
          <input type="text" formControlName="nomor_bon" class="form-input" placeholder="PM-001" />
        </div>

        <div class="form-group">
          <label class="form-label">Purpose <span class="text-red-500">*</span></label>
          <input
            type="text"
            formControlName="keperluan"
            class="form-input"
            placeholder="Production"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Date <span class="text-red-500">*</span></label>
          <input type="date" formControlName="tanggal" class="form-input" />
        </div>

        <div class="form-group">
          <label class="form-label">Officer <span class="text-red-500">*</span></label>
          <input
            type="text"
            formControlName="petugas"
            class="form-input"
            placeholder="Officer Name"
          />
        </div>
      </div>

      <div class="mt-4 form-group">
        <label class="form-label">Notes</label>
        <textarea
          formControlName="keterangan"
          rows="3"
          class="form-input"
          placeholder="Additional notes (optional)"
        ></textarea>
      </div>
    </form>

    <div class="modal-footer">
      <button type="button" (click)="closePemakaianModal()" class="btn-secondary">Cancel</button>
      <button
        type="submit"
        [disabled]="!pemakaianForm.valid"
        (click)="submitPemakaian()"
        class="text-white bg-red-600 btn"
      >
        Save Usage
      </button>
    </div>
  </div>
</div>

<!-- Modal Riwayat Transaksi -->
<div *ngIf="showHistoryModal()" class="modal-overlay" (click)="closeHistoryModal()">
  <div class="modal-container modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Transaction History</h2>
      <button class="modal-close" (click)="closeHistoryModal()">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>

    <!-- Filter Section -->
    <div class="modal-filter">
      <div class="info-grid">
        <div class="form-group">
          <label class="form-label">Item Type</label>
          <select
            [value]="filterBarangHistory()"
            (change)="filterBarangHistory.set($any($event.target).value); applyHistoryFilter()"
            class="form-input"
          >
            <option *ngFor="let option of bahanBakuOptions" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Transaction Type</label>
          <select
            [value]="filterJenisTransaksi()"
            (change)="filterJenisTransaksi.set($any($event.target).value); applyHistoryFilter()"
            class="form-input"
          >
            <option value="semua">All Transactions</option>
            <option value="penerimaan">Receipt</option>
            <option value="pemakaian">Usage</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">From Date</label>
          <input
            type="date"
            [value]="filterDateFrom()"
            (change)="filterDateFrom.set($any($event.target).value); applyHistoryFilter()"
            class="form-input"
          />
        </div>

        <div class="form-group">
          <label class="form-label">To Date</label>
          <input
            type="date"
            [value]="filterDateTo()"
            (change)="filterDateTo.set($any($event.target).value); applyHistoryFilter()"
            class="form-input"
          />
        </div>
      </div>

      <div class="flex justify-end mt-3">
        <button (click)="resetHistoryFilter()" class="btn-secondary">Reset Filter</button>
      </div>
    </div>

    <!-- Transaction List -->
    <div class="modal-body">
      <div *ngIf="filteredTransactions().length === 0" class="empty-state">
        <svg
          class="w-16 h-16 mx-auto mb-4 text-gray-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          />
        </svg>
        <h3 class="mb-2 text-lg font-semibold text-gray-900">No transactions</h3>
        <p class="text-gray-600">No transaction history matches the filters</p>
      </div>

      <div class="transaction-list">
        <div *ngFor="let transaction of filteredTransactions()" class="transaction-card">
          <div class="transaction-header">
            <div
              class="transaction-icon"
              [class.icon-success]="transaction.jenis === 'penerimaan'"
              [class.icon-danger]="transaction.jenis === 'pemakaian'"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  *ngIf="transaction.jenis === 'penerimaan'"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v16m8-8H4"
                />
                <path
                  *ngIf="transaction.jenis === 'pemakaian'"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20 12H4"
                />
              </svg>
            </div>

            <div class="transaction-info">
              <h4 class="transaction-title">{{ transaction.barang }}</h4>
              <div class="transaction-meta">
                <span
                  class="badge"
                  [class.badge-success]="transaction.jenis === 'penerimaan'"
                  [class.badge-danger]="transaction.jenis === 'pemakaian'"
                >
                  {{ transaction.jenis === 'penerimaan' ? 'Receipt' : 'Usage' }}
                </span>
                <span class="transaction-no">{{ transaction.nomor_bon }}</span>
              </div>
            </div>

            <div class="transaction-amount">
              <p
                class="amount-value"
                [class.text-green-600]="transaction.jenis === 'penerimaan'"
                [class.text-red-600]="transaction.jenis === 'pemakaian'"
              >
                {{ transaction.jenis === 'penerimaan' ? '+' : '-'
                }}{{ formatNumber(transaction.jumlah) }} Kg
              </p>
              <p class="amount-date">{{ formatDate(transaction.tanggal) }}</p>
            </div>
          </div>

          <div class="transaction-details">
            <div class="detail-item">
              <span class="detail-label">Vehicle No.</span>
              <span class="detail-value">{{ transaction.nomor_kendaraan }}</span>
            </div>
            <div class="detail-item" *ngIf="transaction.suplier">
              <span class="detail-label">Supplier</span>
              <span class="detail-value">{{ transaction.suplier }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Driver</span>
              <span class="detail-value">{{ transaction.supir }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Officer</span>
              <span class="detail-value">{{ transaction.petugas }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

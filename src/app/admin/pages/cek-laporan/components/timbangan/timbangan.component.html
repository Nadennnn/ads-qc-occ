<!-- src/app/admin/pages/cek-laporan/components/timbangan/timbangan.component.html -->

<div class="laporan-container">
  <!-- Header -->
  <div class="header no-print">
    <div class="flex justify-start items-center gap-3">
      <img src="ads-logo1.png" class="w-10 h-auto" alt="PT. Agro Deli Serdang" />
      <h1 class="title">Weighing Report</h1>
    </div>
    <p class="subtitle">Complete weighing data report</p>
  </div>

  <!-- Filter Section -->
  <div class="filter-section no-print">
    <form [formGroup]="filterForm" class="filter-form">
      <!-- Period Filter -->
      <div class="filter-group">
        <label class="label">Period</label>
        <select formControlName="period" class="select">
          <option *ngFor="let opt of periodOptions" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>
      </div>

      <!-- Custom Date Range -->
      <div *ngIf="isCustomPeriod" class="filter-group">
        <label class="label">Start Date</label>
        <input type="date" formControlName="startDate" class="input" />
      </div>

      <div *ngIf="isCustomPeriod" class="filter-group">
        <label class="label">End Date</label>
        <input type="date" formControlName="endDate" class="input" />
      </div>

      <!-- Status Filter -->
      <!-- <div class="filter-group">
        <label class="label">Status</label>
        <select formControlName="status" class="select">
          <option *ngFor="let opt of statusOptions" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>
      </div> -->

      <!-- Tipe Filter -->
      <div class="filter-group">
        <label class="label">Material Type</label>
        <select formControlName="tipe" class="select">
          <option *ngFor="let opt of tipeOptions" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>
      </div>
    </form>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="flex flex-col items-center justify-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
      <p class="text-gray-600">Loading report data...</p>
    </div>
  </div>

  <!-- Data Table -->
  <div class="data-section mb-6" *ngIf="!isLoading">
    <h3 class="section-title">Weighing Data ({{ filteredData.length }} records)</h3>

    <div *ngIf="filteredData.length === 0" class="empty-state">
      <div class="flex flex-col items-center justify-center py-12">
        <lucide-icons [iconsName]="'inbox'" [size]="48" [color]="'#9CA3AF'" class="mb-4" />
        <p class="text-gray-500 text-lg font-medium">No data found for the selected filters</p>
        <p class="text-gray-400 text-sm mt-2">Try changing the filters or time period</p>
      </div>
    </div>

    <div *ngIf="filteredData.length > 0" class="table-container">
      <table class="data-table">
        <thead class="text-center">
          <tr>
            <th>No.</th>
            <th>Date</th>
            <th>Ticket No.</th>
            <th>Vehicle No.</th>
            <th>Customer</th>
            <th>Supplier</th>
            <th>Item Name</th>
            <th>Type</th>
            <th>Gross (kg)</th>
            <th>Tare (kg)</th>
            <th>Net (kg)</th>
            <!-- <th>Status</th> -->
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of filteredData; let i = index">
            <td class="text-center">{{ i + 1 }}</td>
            <td class="text-center">{{ formatDate(item.timestamp) }}</td>
            <td class="text-center font-semibold">{{ item.noTiket }}</td>
            <td class="text-center">{{ item.noKendaraan }}</td>
            <td class="text-center">
              {{
                item.laporanCustomer == null || item.laporanCustomer === '---'
                  ? '-'
                  : item.laporanCustomer
              }}
            </td>
            <td class="text-center">
              {{
                item.laporanSupplier == null || item.laporanSupplier === '---'
                  ? '-'
                  : item.laporanSupplier
              }}
            </td>
            <td class="text-center">{{ item.namaBarang }}</td>
            <td class="text-center">
              <span class="badge" [ngClass]="getTipeClass(item.tipeBahan)">
                {{ getTipeBadge(item.tipeBahan) == 'Bahan Baku' ? 'Raw Material' : 'Other' }}
              </span>
            </td>
            <td class="text-center">{{ formatNumber(item.timbanganPertama) + 'Kg' }}</td>
            <td class="text-center">
              {{ formatNumber(item.timbanganPertama - (item.beratNetto || 0)) + 'Kg' }}
            </td>
            <td class="text-center font-semibold">
              {{ item.beratNetto ? formatNumber(item.beratNetto) + 'Kg' : '-' }}
            </td>
            <!-- <td class="text-center">
              <span class="badge" [ngClass]="getStatusClass(item.statusTimbangan)">
                {{ getStatusBadge(item.statusTimbangan) }}
              </span>
            </td> -->
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Detailed Stats -->
  <div class="detail-stats" *ngIf="isRincianVisible && !isLoading">
    <h3 class="section-title">Weight Details</h3>
    <div class="w-full border-b border-gray-100 my-2"></div>

    <div class="stats-table">
      <div class="stats-group">
        <div class="stats-row">
          <span class="stats-label">Total Gross</span>
          <span class="stats-value">{{ formatNumber(stats.totalBruto) }} kg</span>
        </div>
        <div class="stats-row">
          <span class="stats-label">Average Gross</span>
          <span class="stats-value">{{ formatNumber(stats.rataRataBruto) }} kg</span>
        </div>
      </div>

      <div class="w-full border-b border-gray-100 my-2"></div>

      <div class="stats-group">
        <div class="stats-row">
          <span class="stats-label">Total Tare</span>
          <span class="stats-value">{{ formatNumber(stats.totalTara) }} kg</span>
        </div>
        <div class="stats-row">
          <span class="stats-label">Average Tare</span>
          <span class="stats-value">{{ formatNumber(stats.rataRataTara) }} kg</span>
        </div>
      </div>

      <div class="w-full border-b border-gray-100 my-2"></div>

      <div class="stats-group">
        <div class="stats-row">
          <span class="stats-label">Total Net</span>
          <span class="stats-value text-danger">{{ formatNumber(stats.totalNetto) }} kg</span>
        </div>
        <div class="stats-row">
          <span class="stats-label">Average Net</span>
          <span class="stats-value">{{ formatNumber(stats.rataRataNetto) }} kg</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons no-print" *ngIf="!isLoading">
    <button
      class="btn bg-neutral-800 text-white flex justify-center w-auto gap-3 items-center"
      (click)="toggleShowRincian()"
    >
      <lucide-icon [name]="isRincianVisible ? 'chevron-up' : 'chevron-down'"></lucide-icon>
      <span *ngIf="isRincianVisible">Hide Details</span>
      <span *ngIf="!isRincianVisible">Show Details</span>
    </button>
    <button
      class="btn bg-neutral-800 text-white flex justify-center w-auto gap-3 items-center"
      (click)="exportToExcel()"
      [disabled]="filteredData.length === 0"
    >
      <lucide-icons [iconsName]="'sheet'" class="text-white" /> Export to Excel
    </button>
    <button
      class="btn bg-gray-200 text-neutral-800 flex justify-center w-auto gap-3 items-center"
      (click)="printLaporan()"
      [disabled]="filteredData.length === 0"
    >
      <lucide-icons [iconsName]="'printer-check'" class="text-neutral-800" /> Print Report
    </button>
  </div>

  <!-- PROFESSIONAL PRINT REPORT (A4 OPTIMIZED) -->
  <div class="print-report-a4">
    <div class="print-header-a4">
      <div class="print-header-top">
        <img src="ads-logo1.png" alt="Logo PT Agro Deli Serdang" class="print-logo-a4" />
        <div class="print-title-block">
          <h1 class="print-title">PT AGRO DELI SERDANG</h1>
          <p class="print-subtitle">WEIGHING DATA REPORT</p>
        </div>
      </div>
      <div class="print-meta-row">
        <div>
          Period: <strong>{{ periodLabel }}</strong>
        </div>
        <div>
          Print Date: <strong>{{ formatDate(currentDate) }}</strong>
        </div>
        <div>
          Total Records: <strong>{{ filteredData.length }} entries</strong>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <table class="print-data-table">
      <thead>
        <tr>
          <th>No.</th>
          <th>Date</th>
          <th>Ticket No.</th>
          <th>Vehicle</th>
          <th>Customer</th>
          <th>Supplier</th>
          <th>Item</th>
          <th>Type</th>
          <th>Gross (kg)</th>
          <th>Tare (kg)</th>
          <th>Net (kg)</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of filteredData; let i = index">
          <td>{{ i + 1 }}</td>
          <td>{{ formatDate(item.timestamp) }}</td>
          <td>{{ item.noTiket }}</td>
          <td>{{ item.noKendaraan }}</td>
          <td>{{ item.laporanCustomer == '---' ? '-' : item.laporanCustomer || '-' }}</td>
          <td>{{ item.laporanSupplier == '---' ? '-' : item.laporanSupplier || '-' || '-' }}</td>
          <td>{{ item.namaBarang }}</td>
          <td>{{ item.tipeBahan === 'bahan-baku' ? 'Raw Material' : 'Other' }}</td>
          <td class="text-right">{{ formatNumber(item.timbanganPertama) }}</td>
          <td class="text-right">
            {{ formatNumber(item.timbanganPertama - (item.beratNetto || 0)) }}
          </td>
          <td class="text-right">{{ item.beratNetto ? formatNumber(item.beratNetto) : '-' }}</td>
        </tr>
      </tbody>
    </table>

    <!-- Summary Stats -->
    <table class="print-summary-table">
      <tbody>
        <tr>
          <td class="font-bold">Total Gross</td>
          <td class="text-right">
            <strong> {{ formatNumber(stats.totalBruto) }} kg </strong>
          </td>
          <td class="font-bold">Average Gross</td>
          <td class="text-right">
            <strong> {{ formatNumber(stats.rataRataBruto) }} kg </strong>
          </td>
        </tr>
        <tr>
          <td class="font-bold">Total Tare</td>
          <td class="text-right">
            <strong> {{ formatNumber(stats.totalTara) }} kg </strong>
          </td>
          <td class="font-bold">Average Tare</td>
          <td class="text-right">
            <strong> {{ formatNumber(stats.rataRataTara) }} kg </strong>
          </td>
        </tr>
        <tr>
          <td class="font-bold">Total Net</td>
          <td class="text-right">
            <strong>{{ formatNumber(stats.totalNetto) }} kg</strong>
          </td>
          <td class="font-bold">Average Net</td>
          <td class="text-right">
            <strong> {{ formatNumber(stats.rataRataNetto) }} kg </strong>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

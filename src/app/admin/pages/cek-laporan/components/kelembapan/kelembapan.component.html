<!-- src/app/admin/pages/cek-laporan/cek-laporan.component.html -->

<div class="laporan-container">
  <!-- Header -->
  <div class="header no-print">
    <div class="flex justify-start items-center gap-3">
      <img src="ads-logo1.png" class="w-10 h-auto" alt="PT. Agro Deli Serdang" />
      <h1 class="title">QC Report</h1>
    </div>
    <p class="subtitle">Complete moisture test data report</p>
  </div>

  <!-- Compact Version -->
  <div class="filter-section no-print">
    <div class="filter-compact">
      <div class="filter-compact-header">
        <lucide-icons [iconsName]="'filter'" [size]="18" [color]="'#6B7280'" />
        <span class="filter-compact-title">Filter</span>
        <span *ngIf="hasActiveFilters" class="filter-count">{{ activeFilterCount }}</span>
      </div>

      <form [formGroup]="filterForm" class="filter-compact-form">
        <select formControlName="period" class="filter-compact-select">
          <option *ngFor="let opt of periodOptions" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>

        <ng-container *ngIf="isCustomPeriod">
          <input type="date" formControlName="startDate" class="filter-compact-input" />
          <input type="date" formControlName="endDate" class="filter-compact-input" />
        </ng-container>

        <!-- <select formControlName="status" class="filter-compact-select">
          <option *ngFor="let opt of statusOptions" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select> -->

        <!-- <select formControlName="tipe" class="filter-compact-select">
          <option *ngFor="let opt of tipeOptions" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select> -->

        <select formControlName="namaBarang" class="filter-compact-select">
          <option *ngFor="let opt of bahanBakuOptions" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>

        <button
          *ngIf="hasActiveFilters"
          type="button"
          (click)="resetFilters()"
          class="filter-compact-reset"
          title="Reset Filter"
        >
          <lucide-icons [iconsName]="'x'" [size]="16" [color]="'#6B7280'" />
        </button>
      </form>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="flex flex-col items-center justify-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
      <p class="text-gray-600">Loading report data...</p>
    </div>
  </div>

  <!-- Data Table -->
  <div class="data-section mb-6" *ngIf="!isLoading">
    <h3 class="section-title">Moisture Test Data ({{ displayedData.length }} records)</h3>

    <!-- Empty State -->
    <div *ngIf="displayedData.length === 0" class="empty-state">
      <div class="flex flex-col items-center justify-center py-12">
        <lucide-icons [iconsName]="'inbox'" [size]="48" [color]="'#9CA3AF'" class="mb-4" />
        <p class="text-gray-500 text-lg font-medium">No data found for the selected filters</p>
        <p class="text-gray-400 text-sm mt-2">Try changing the filters or time period</p>
      </div>
    </div>

    <!-- Table -->
    <div *ngIf="displayedData.length > 0" class="table-container">
      <table class="data-table">
        <thead class="text-center">
          <tr>
            <th>No.</th>
            <th>Date</th>
            <th>Vehicle No.</th>
            <th>Supplier</th>
            <th>Item Name</th>
            <th>Average Test Result</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of displayedData; let i = index">
            <td class="text-center">{{ i + 1 }}</td>
            <td class="text-center">{{ formatDate(item.timestamp) }}</td>
            <td class="text-center">{{ item.noKendaraan }}</td>
            <td class="text-center">
              {{
                item.laporanSupplier == null || item.laporanSupplier === '---'
                  ? '-'
                  : item.laporanSupplier
              }}
            </td>
            <td class="text-center">{{ item.namaBarang }}</td>
            <td class="text-center">
              <span class="badge" [ngClass]="getTipeClass(item.tipeBahan)">
                {{ item.hasilUjiKelembapan?.averageMoisture }}%
              </span>
            </td>
            <td class="text-center">
              <button class="cursor-pointer" (click)="viewDetail(item)">
                <lucide-icons [iconsName]="'eye'" [color]="'green'" />
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Detailed Stats -->
  <!-- DETAIL STATS SECTION - DISESUAIKAN UNTUK KELEMBAPAN -->
  <div class="detail-stats" *ngIf="isRincianVisible && !isLoading">
    <h3 class="section-title">Moisture Data Details</h3>
    <div class="w-full border-b border-gray-100 my-2"></div>

    <div class="stats-table">
      <!-- Group 1: Moisture/Kelembapan -->
      <div class="stats-group">
        <div class="stats-row">
          <span class="stats-label">Total Moisture</span>
          <span class="stats-value">{{ calculateTotalMoisture() }}%</span>
        </div>
        <div class="stats-row">
          <span class="stats-label">Average Moisture</span>
          <span class="stats-value">{{ calculateAvgMoisture() }}%</span>
        </div>
      </div>

      <div class="w-full border-b border-gray-100 my-2"></div>

      <!-- Group 2: Claim -->
      <div class="stats-group">
        <div class="stats-row">
          <span class="stats-label">Total Claim Value</span>
          <span class="stats-value">{{ calculateTotalClaim() }}%</span>
        </div>
        <div class="stats-row">
          <span class="stats-label">Average Claim</span>
          <span class="stats-value">{{ calculateAvgClaim() }}%</span>
        </div>
      </div>

      <div class="w-full border-b border-gray-100 my-2"></div>

      <!-- Group 5: Waste Deduction -->
      <div class="stats-group">
        <div class="stats-row">
          <span class="stats-label">Total Waste Deduction</span>
          <span class="stats-value">{{ formatNumber(calculateTotalPotonganSampah()) }} kg</span>
        </div>
        <div class="stats-row">
          <span class="stats-label">Average Waste Deduction</span>
          <span class="stats-value">{{ calculateAvgPotonganSampah() }} kg</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons no-print" *ngIf="!isLoading">
    <button
      class="btn bg-neutral-800 text-white flex justify-center w-auto gap-3 items-center"
      (click)="toggleRincian()"
    >
      <lucide-icon [name]="isRincianVisible ? 'chevron-up' : 'chevron-down'"></lucide-icon>
      <span>{{ isRincianVisible ? 'Hide' : 'Show' }} Details</span>
    </button>

    <button
      class="btn bg-neutral-800 text-white flex justify-center w-auto gap-3 items-center"
      (click)="exportToExcel()"
      [disabled]="displayedData.length === 0"
    >
      <lucide-icons [iconsName]="'sheet'" class="text-white" />
      Export to Excel
    </button>

    <button
      class="btn bg-gray-200 text-neutral-800 flex justify-center w-auto gap-3 items-center"
      (click)="printLaporan()"
      [disabled]="displayedData.length === 0"
    >
      <lucide-icons [iconsName]="'printer-check'" class="text-neutral-800" />
      Print Report
    </button>
  </div>

  <!-- PROFESSIONAL PRINT REPORT (A4 OPTIMIZED) -->
  <div class="print-report-a4">
    <div class="print-header-a4">
      <div class="print-header-top">
        <img src="ads-logo1.png" alt="Logo PT Agro Deli Serdang" class="print-logo-a4" />
        <div class="print-title-block">
          <h1 class="print-title">PT AGRO DELI SERDANG</h1>
          <p class="print-subtitle">MOISTURE TEST DATA REPORT</p>
        </div>
      </div>
      <div class="print-meta-row">
        <div>
          Period: <strong>{{ periodLabel }}</strong>
        </div>
        <div>
          Print Date: <strong>{{ formatDate(currentDate) }}</strong>
        </div>
        <div>
          Total Records: <strong>{{ displayedData.length }} entries</strong>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <table class="print-data-table">
      <thead>
        <tr>
          <th>No.</th>
          <th>Date</th>
          <th>Vehicle No.</th>
          <th>Supplier</th>
          <th>Item Name</th>
          <th>Average Test Result</th>
          <th>Claim Value</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of displayedData; let i = index">
          <td>{{ i + 1 }}</td>
          <td>{{ formatDate(item.timestamp) }}</td>
          <td>{{ item.noKendaraan }}</td>
          <td>{{ item.laporanSupplier || '-' }}</td>
          <td>{{ item.namaBarang }}</td>
          <td class="text-center">
            <strong>{{ item.hasilUjiKelembapan?.averageMoisture || '-' }}%</strong>
          </td>
          <td class="text-center">
            <ng-container *ngIf="item.hasilUjiKelembapan?.claimPercentage">
              {{ item.hasilUjiKelembapan?.claimPercentage }}%
            </ng-container>
            <ng-container *ngIf="!item.hasilUjiKelembapan?.claimPercentage"> - </ng-container>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Summary Stats -->
    <table class="print-summary-table">
      <tbody>
        <tr>
          <td>Total Transactions</td>
          <td class="text-right">{{ displayedData.length }}</td>
          <td>Average Moisture</td>
          <td class="text-right">{{ calculateAvgMoisture() }}%</td>
        </tr>
        <tr>
          <td>Total Moisture</td>
          <td class="text-right">{{ calculateTotalMoisture() }}%</td>
          <td>Total Claim</td>
          <td class="text-right">{{ calculateTotalClaim() }}%</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Detail Modal -->
  <div *ngIf="isModalOpen" class="modal-overlay" (click)="closeModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="modal-header">
        <h2 class="modal-title">Moisture Test Details</h2>
        <button class="modal-close" (click)="closeModal()">
          <lucide-icons [iconsName]="'x'" [size]="20" [color]="'#6B7280'" />
        </button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body" *ngIf="selectedItem">
        <!-- General Info -->
        <div class="info-section">
          <h3 class="info-section-title">General Information</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Ticket No.</span>
              <span class="info-value">{{ selectedItem.noTiket }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Vehicle No.</span>
              <span class="info-value">{{ selectedItem.noKendaraan }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Item Name</span>
              <span class="info-value">{{ selectedItem.namaBarang }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">{{
                selectedItem.jenisRelasi === 'supplier' ? 'Supplier' : 'Customer'
              }}</span>
              <span class="info-value">{{ getSupplierDisplay(selectedItem.namaRelasi) }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Driver Name</span>
              <span class="info-value">{{ selectedItem.namaSupir || '-' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Date</span>
              <span class="info-value">{{ formatDate(selectedItem.timestamp) }}</span>
            </div>
          </div>
        </div>

        <!-- Moisture Test Data -->
        <div class="info-section" *ngIf="selectedItem.hasilUjiKelembapan">
          <h3 class="info-section-title">Moisture Test Data</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Number of Test Points</span>
              <span class="info-value">{{ selectedItem.hasilUjiKelembapan.pointsChecked }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Total Moisture</span>
              <span class="info-value">{{ selectedItem.hasilUjiKelembapan.totalMoisture }}%</span>
            </div>
            <div class="info-item">
              <span class="info-label">Average Moisture</span>
              <span class="info-value font-semibold">
                {{ selectedItem.hasilUjiKelembapan.averageMoisture }}%
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">Claim Value</span>
              <span
                class="info-value font-semibold"
                [ngClass]="{
                  'text-red-600': selectedItem.hasilUjiKelembapan.claimPercentage > 0,
                  'text-green-600': selectedItem.hasilUjiKelembapan.claimPercentage < 0,
                  'text-gray-600': selectedItem.hasilUjiKelembapan.claimPercentage === 0,
                }"
              >
                {{ selectedItem.hasilUjiKelembapan.claimPercentage > 0 ? '+' : ''
                }}{{ selectedItem.hasilUjiKelembapan.claimPercentage }}%
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">Material Weight</span>
              <span class="info-value"
                >{{ formatNumber(selectedItem.hasilUjiKelembapan.beratBahan) }} kg</span
              >
            </div>
            <div class="info-item">
              <span class="info-label">Net Weight</span>
              <span class="info-value"
                >{{ formatNumber(selectedItem.hasilUjiKelembapan.netto) }} kg</span
              >
            </div>
            <div class="info-item">
              <span class="info-label">Waste Deduction</span>
              <span class="info-value"
                >{{ formatNumber(selectedItem.hasilUjiKelembapan.potonganSampah) }} kg</span
              >
            </div>
            <div class="info-item">
              <span class="info-label">Test Date</span>
              <span class="info-value">{{
                formatDate(selectedItem.hasilUjiKelembapan.tanggalUji)
              }}</span>
            </div>
          </div>
        </div>

        <!-- Measurement Points -->
        <div
          class="info-section"
          *ngIf="selectedItem.hasilUjiKelembapan?.moisturePoints?.length > 0"
        >
          <h3 class="info-section-title">
            Measurement Points ({{ selectedItem.hasilUjiKelembapan.moisturePoints.length }} points)
          </h3>
          <div class="titik-grid">
            <div
              *ngFor="let nilai of selectedItem.hasilUjiKelembapan.moisturePoints; let i = index"
              class="titik-card"
            >
              <div class="titik-number">Point {{ i + 1 }}</div>
              <div class="titik-value">{{ nilai }}%</div>
            </div>
          </div>
        </div>

        <!-- Weighing Data -->
        <div class="info-section" *ngIf="selectedItem.hasilTara">
          <h3 class="info-section-title">Weighing Data</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Gross Weight</span>
              <span class="info-value"
                >{{ formatNumber(selectedItem.hasilTara.beratBruto) }} kg</span
              >
            </div>
            <div class="info-item">
              <span class="info-label">Tare Weight</span>
              <span class="info-value"
                >{{ formatNumber(selectedItem.hasilTara.beratTara) }} kg</span
              >
            </div>
            <div class="info-item">
              <span class="info-label">Moisture Deduction</span>
              <span class="info-value text-red-600"
                >{{ formatNumber(selectedItem.hasilTara.potonganMoisture) }} kg</span
              >
            </div>
            <div class="info-item">
              <span class="info-label">Final Net Weight</span>
              <span class="info-value font-semibold"
                >{{ formatNumber(selectedItem.hasilTara.beratNetto) }} kg</span
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeModal()">Close</button>
      </div>
    </div>
  </div>
</div>
